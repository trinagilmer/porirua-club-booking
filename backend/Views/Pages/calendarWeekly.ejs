<!DOCTYPE html>
<html>
<head>
  <link rel="stylesheet" href="/css/main.css">
  <meta charset="utf-8" />
  <title>Staff — Weekly Calendar</title>
  <style>
    body { font-family: system-ui, Arial, sans-serif; margin: 20px; }
    header { display:flex; justify-content:space-between; align-items:center; gap:12px; }
    .nav a { margin-right: 8px; text-decoration:none; color:#1d4ed8; }
    table { width:100%; border-collapse: collapse; margin-top: 12px; }
    th, td { border: 1px solid #ddd; padding: 8px; vertical-align: top; }
    th { background: #f5f5f5; text-align: center; }
    .muted { color:#6b7280; font-size:.9rem; }
    .today { background: #FEF9C3; }
    .past  { color:#6b7280; }
    ul { margin:0; padding-left: 12px; }

    .legend { color:#6b7280; font-size:.9rem; margin-top:6px; }
    .i { padding:2px 6px; border-radius:10px; font-size:.75rem; border:1px solid #e5e7eb; }
    .i.fn { background:#eef2ff; color:#3730a3; border-color:#c7d2fe; }
    .i.bk { background:#f3f4f6; color:#374151; border-color:#e5e7eb; }

    .ev { cursor:pointer; padding:2px 0; }
    .ev:hover { background:#f9fafb; border-radius:6px; }

    /* modal styles */
    #modal { display:none; position:fixed; top:0; left:0; right:0; bottom:0;
             background:rgba(0,0,0,.5); align-items:center; justify-content:center; }
    #modal .box { background:#fff; border-radius:12px; padding:20px; width:400px; max-width:90%; }
    #modal h2 { margin-top:0; }
    #modal button { margin-top:12px; padding:6px 12px; border:1px solid #ddd; border-radius:6px; background:#f3f4f6; cursor:pointer; }
    #modal button.primary { background:#3b82f6; color:#fff; border-color:#3b82f6; }
  </style>
</head>
<body>
  <%- include('../Partials/header', { active: 'calendar' }) %>

  <header>
    <h1>Weekly Calendar</h1>
    <div class="nav">
      <a id="prev" href="#">◀ Prev</a>
      <a id="next" href="#">Next ▶</a>
      <span class="muted">Week: <%= start %> → <%= end %></span>
    </div>
  </header>

  <div class="legend">
    <span class="i fn">Function</span>
    <span class="i bk">Booking</span>
  </div>

  <table>
    <thead>
      <tr>
        <% days.forEach(d => { %>
          <th><%= d.dateStr %></th>
        <% }) %>
      </tr>
    </thead>
    <tbody>
      <tr>
        <% days.forEach(d => { const list = events[d.dateKey] || []; %>
          <td class="<%= d.isToday ? 'today' : (d.isPast ? 'past' : '') %>">
            <% if (!list.length) { %>
              <div class="muted">No events</div>
            <% } else { %>
              <ul>
                <% list.forEach(ev => { %>
                  <li class="ev" 
                      data-type="<%= ev.evtype %>"
                      data-id="<%= ev.id %>"
                      data-name="<%= ev.event_name || ev.name %>"
                      data-room="<%= ev.room || '' %>"
                      data-attendees="<%= ev.attendees || ev.guests || '' %>"
                      data-status="<%= ev.status || '' %>"
                      data-contact="<%= ev.contact_name || '' %>"
                      data-phone="<%= ev.contact_phone || '' %>">
                    <span class="i <%= ev.evtype === 'function' ? 'fn' : 'bk' %>">
                      <%= ev.evtype === 'function' ? 'Function' : 'Booking' %>
                    </span>
                    <strong><%= ev.event_name || ev.name %></strong>
                  </li>
                <% }) %>
              </ul>
            <% } %>
          </td>
        <% }) %>
      </tr>
    </tbody>
  </table>

  <!-- modal -->
  <div id="modal">
    <div class="box">
      <h2 id="mTitle"></h2>
      <p id="mDetails" class="muted"></p>
      <div id="mActions"></div>
      <button onclick="closeModal()">Close</button>
    </div>
  </div>

  <div id="meta" data-start="<%= start %>" data-end="<%= end %>"></div>
  <script>
    const meta = document.getElementById('meta');
    const start = meta.dataset.start;
    const prev = document.getElementById('prev');
    const next = document.getElementById('next');

    function shift(dateStr, days) {
      const d = new Date(dateStr + 'T00:00:00');
      d.setDate(d.getDate() + days);
      return d.toISOString().slice(0,10);
    }
    prev.href = `/staff/calendar/weekly?start=${shift(start, -7)}`;
    next.href = `/staff/calendar/weekly?start=${shift(start, +7)}`;

    // modal
    const modal = document.getElementById('modal');
    const mTitle = document.getElementById('mTitle');
    const mDetails = document.getElementById('mDetails');
    const mActions = document.getElementById('mActions');

    document.querySelectorAll('.ev').forEach(el => {
      el.addEventListener('click', () => {
        const type = el.dataset.type;
        const id   = el.dataset.id;
        const name = el.dataset.name;
        const room = el.dataset.room;
        const att  = el.dataset.attendees;
        const status = el.dataset.status;
        const contact = el.dataset.contact;
        const phone = el.dataset.phone;

        mTitle.textContent = (type === 'function' ? "Function: " : "Booking: ") + name;
        mDetails.textContent = [
          room ? "Room: " + room : "",
          att ? "Attendees: " + att : "",
          status ? "Status: " + status : "",
          contact ? "Contact: " + contact : "",
          phone ? "Phone: " + phone : ""
        ].filter(Boolean).join(" · ");

        mActions.innerHTML = "";
        if (type === "function") {
          const btn = document.createElement("a");
          btn.href = `/functions/${id}/edit`;
          btn.textContent = "Edit Function";
          btn.className = "primary";
          btn.style.marginRight = "8px";
          btn.style.padding = "6px 12px";
          btn.style.borderRadius = "6px";
          btn.style.background = "#3b82f6";
          btn.style.color = "#fff";
          mActions.appendChild(btn);
        } else {
          const btn = document.createElement("a");
          btn.href = `/bookings/${id}`;
          btn.textContent = "View Booking";
          btn.className = "primary";
          btn.style.marginRight = "8px";
          btn.style.padding = "6px 12px";
          btn.style.borderRadius = "6px";
          btn.style.background = "#6b7280";
          btn.style.color = "#fff";
          mActions.appendChild(btn);
        }

        modal.style.display = "flex";
      });
    });

    function closeModal() { modal.style.display = "none"; }
  </script>
</body>
</html>


