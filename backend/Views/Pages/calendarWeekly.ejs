<!DOCTYPE html>
<head>
  <html><link rel="stylesheet" href="/css/main.css">
  <meta charset="utf-8" />
  <title>Staff — Weekly Calendar</title>
  <style>
    body { font-family: system-ui, Arial, sans-serif; margin: 20px; }
    header { display:flex; justify-content:space-between; align-items:center; gap:12px; }
    .nav a { margin-right: 8px; }
    table { width:100%; border-collapse: collapse; margin-top: 12px; }
    th, td { border: 1px solid #ddd; padding: 8px; vertical-align: top; }
    th { background: #f5f5f5; text-align: left; }
    .muted { color:#6b7280; font-size:.9rem; }
    .today { background: #FEF9C3; }     /* light yellow */
    .past  { color:#6b7280; }
    ul { margin:0; padding-left: 16px; }

    /* legend + badges + greyed bookings */
    .legend { color:#6b7280; font-size:.9rem; }
    .i { padding:2px 6px; border-radius:10px; font-size:.75rem; border:1px solid #e5e7eb; }
    .i.fn { background:#eef2ff; color:#3730a3; border-color:#c7d2fe; } /* Function */
    .i.bk { background:#f3f4f6; color:#374151; border-color:#e5e7eb; } /* Booking */
    .ev.bk { color:#6b7280; } /* grey text for bookings */
  </style>
</head>
<body>
  <%- include('../Partials/header', { active: 'calendar' }) %>
  <header>
    <h1>Weekly Calendar</h1>
    <div class="nav">
      <a id="prev" href="#">◀ Prev</a>
      <a id="next" href="#">Next ▶</a>
      <span class="muted">Week: <%= start %> → <%= end %></span>
    </div>
  </header>

  <div class="legend" style="margin-top:6px;">
    <span class="i fn">Function</span>
    <span class="i bk">Booking</span>
  </div>

  <table>
    <thead>
      <tr>
        <% (days || []).forEach(d => { %>
          <th><%= d.dateStr %></th>
        <% }) %>
      </tr>
    </thead>
    <tbody>
      <tr>
        <% (days || []).forEach(d => { 
             const list = (events && events[d.dateKey]) || []; %>
          <td class="<%= d.isToday ? 'today' : (d.isPast ? 'past' : '') %>">
            <% if (!list.length) { %>
              <div class="muted">No events</div>
            <% } else { %>
              <ul>
                <% list.forEach(ev => { %>
                  <% if (ev.evtype === 'booking') { %>
                    <!-- Greyed-out booking -->
                    <li class="ev bk">
                      <span class="i bk">Booking</span>
                      <strong><%= ev.name %></strong>
                      <% if (ev.type) { %> · <%= ev.type %><% } %>
                      <% if (ev.guests) { %> · <%= ev.guests %> pax<% } %>
                      <% if (ev.status) { %> · <%= ev.status %><% } %>
                    </li>
                  <% } else { %>
                    <!-- Function -->
                    <li class="ev fn">
                      <span class="i fn">Function</span>
                      <strong><%= ev.event_name %></strong>
                      <% if (ev.room) { %> — <%= ev.room %><% } %>
                      <% if (ev.attendees) { %> · <%= ev.attendees %> pax<% } %>
                      <% if (ev.contact_name || ev.contact_phone) { %>
                        <div class="muted">
                          <%= ev.contact_name || '' %><%= ev.contact_phone ? ' · ' + ev.contact_phone : '' %>
                        </div>
                      <% } %>
                    </li>
                  <% } %>
                <% }) %>
              </ul>
            <% } %>
          </td>
        <% }) %>
      </tr>
    </tbody>
  </table>

  <div id="meta" data-start="<%= start %>" data-end="<%= end %>"></div>
  <script>
    const meta = document.getElementById('meta');
    const start = meta.dataset.start; // yyyy-MM-dd
    const prev = document.getElementById('prev');
    const next = document.getElementById('next');

    function shift(dateStr, days) {
      const d = new Date(dateStr + 'T00:00:00');
      d.setDate(d.getDate() + days);
      const y = d.getFullYear();
      const m = String(d.getMonth()+1).padStart(2,'0');
      const dd = String(d.getDate()).padStart(2,'0');
      return `${y}-${m}-${dd}`;
    }
    prev.href = `/staff/calendar/weekly?start=${shift(start, -7)}`;
    next.href = `/staff/calendar/weekly?start=${shift(start, +7)}`;
  </script>
</body>
</html>
