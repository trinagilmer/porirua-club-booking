<!DOCTYPE html>
<html>
<head>
  <%- include('../Partials/head') %>
  <meta charset="utf-8" />
  <title>Dashboard</title>
  <link rel="stylesheet" href="/css/main.css">
  <style>
    body { font-family: system-ui, Arial, sans-serif; margin: 24px; background:#fafafa; }
    header { display:flex; justify-content:space-between; align-items:center; margin-bottom:16px; }
    .muted { color:#6b7280; }
    .kpis { display:grid; grid-template-columns: repeat(auto-fit, minmax(160px,1fr)); gap:12px; }
    .kpi { border:1px solid #e5e7eb; border-radius:10px; padding:12px; background:#fff; }
    table { width:100%; border-collapse: collapse; }
    th, td { padding:8px; border-bottom:1px solid #e5e7eb; text-align:left; }
    .pill { padding:2px 8px; border-radius:999px; font-size:.8rem; }
    .pill.confirmed { background:#DCFCE7; color:#065F46; }
    .pill.pending { background:#FEF3C7; color:#92400E; }
    .pill.lead { background:#EDE9FE; color:#5B21B6; }
    .done { text-decoration: line-through; color:#6b7280; }
  </style>
</head>
<body>
  <%- include('../Partials/header', { active: 'dashboard' }) %>

  <header>
    <div>
      <h1>Dashboard</h1>
      <div class="muted">
        Welcome <% if (user && user.name) { %><strong><%= user.name %></strong><% } %>
      </div>
    </div>
    <form method="GET" action="/dashboard">
      <label>Start <input type="date" name="start" value="<%= start %>" /></label>
      <label>End <input type="date" name="end" value="<%= end %>" /></label>
      <button type="submit">Apply</button>
    </form>
  </header>

  <!-- KPIs -->
  <div class="kpis">
    <div class="kpi">
      <div class="muted">Confirmed Functions (period)</div>
      <div style="font-size:1.6rem;"><%= kpi.confirmed_count || 0 %></div>
    </div>
    <div class="kpi">
      <div class="muted">Confirmed Value (period)</div>
      <div style="font-size:1.6rem;">$<%= Number(kpi.confirmed_value || 0).toFixed(2) %></div>
    </div>
    <div class="kpi">
      <div class="muted">Pending</div>
      <div style="font-size:1.6rem;"><%= kpi.pending_count || 0 %></div>
    </div>
    <div class="kpi">
      <div class="muted">Leads</div>
      <div style="font-size:1.6rem;"><%= kpi.lead_count || 0 %></div>
    </div>
  </div>

  <!-- Upcoming Events -->
  <div class="card" style="margin-top:16px;">
    <h3>Upcoming Functions</h3>
    <% if ((upcoming || []).length === 0) { %>
      <div class="muted">No events in this period.</div>
    <% } else { %>
      <table>
        <thead>
          <tr>
            <th>Date / Time</th>
            <th>Event</th>
            <th>Room</th>
            <th>Attendees</th>
            <th>Status</th>
            <th>Total</th>
          </tr>
        </thead>
        <tbody>
          <% upcoming.forEach(f => { %>
            <tr>
              <td><%= new Date(f.event_start).toLocaleString('en-NZ', { dateStyle:'medium', timeStyle:'short' }) %></td>
              <td><%= f.event_name %></td>
              <td><%= f.room || '' %></td>
              <td><%= f.attendees || '' %></td>
              <td><span class="pill <%= f.status %>"><%= f.status %></span></td>
              <td>$<%= Number(f.est_total || 0).toFixed(2) %></td>
            </tr>
          <% }) %>
        </tbody>
      </table>
    <% } %>
  </div>

  <!-- Open Tasks -->
  <div class="card" style="margin-top:16px;">
    <h3>Open Tasks</h3>
    <% if ((tasks || []).length === 0) { %>
      <div class="muted">No open tasks</div>
    <% } else { %>
      <table>
        <thead>
          <tr><th>Task</th><th>Due</th><th>Assignee</th></tr>
        </thead>
        <tbody>
          <% tasks.forEach(t => { %>
            <tr>
              <td><%= t.title %></td>
              <td><%= t.due_date ? new Date(t.due_date).toLocaleDateString('en-NZ') : '' %></td>
              <td><%= t.assignee || '' %></td>
            </tr>
          <% }) %>
        </tbody>
      </table>
    <% } %>
  </div>
</body>
</html>
