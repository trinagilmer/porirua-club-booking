<!DOCTYPE html>
<html lang="en">
<head>
  <%- include('../Partials/head') %>
  <title>Dashboard</title>
</head>
<body>
  <div class="layout">
    <!-- Sidebar Navigation -->
    <aside class="sidebar">
      <div class="sidebar-header">
        <img src="/img/pc-logo.jpg" alt="Porirua Club" class="logo">
        <h2>Porirua Club</h2>
      </div>
      <nav>
        <ul>
          <li class="<%= active === 'dashboard' ? 'active' : '' %>"><a href="/dashboard">Dashboard</a></li>
          <li><a href="/calendar/weekly">Calendar – Weekly</a></li>
          <li><a href="/calendar/monthly">Calendar – Monthly</a></li>
          <li><a href="/functions">Functions</a></li>
          <li><a href="/bookings">Restaurant Bookings</a></li>
          <li><a href="/catalog">Menus & Services</a></li>
          <li><a href="/tasks">Tasks</a></li>
          <li><a href="/contacts">Contacts</a></li>
          <li><a href="/surveys">Surveys</a></li>
          <li><a href="/reports">Reports</a></li>
          <li><a href="/audit">Admin → Audit</a></li>
        </ul>
      </nav>
    </aside>

    <!-- Main Content -->
    <main class="content">
      <%- include('../Partials/header', { active: active }) %>

      <div class="container" style="margin-top:24px;">
        
        <!-- Date Filters -->
        <form method="GET" action="/dashboard" class="filter-form" style="margin-bottom:20px;">
          <label>From: <input type="date" name="from" value="<%= filters?.from || '' %>"></label>
          <label>To: <input type="date" name="to" value="<%= filters?.to || '' %>"></label>
          <button type="submit" class="btn">Apply</button>
          <button type="submit" name="quick" value="week" class="btn">This Week</button>
          <button type="submit" name="quick" value="month" class="btn">This Month</button>
        </form>

        <!-- KPIs -->
        <div class="pc-kpis">
          <div class="kpi-card">
            <div class="kpi-label">Confirmed+ Revenue</div>
            <div class="kpi-value">$<%= (kpis.confirmed_price || 0).toLocaleString() %></div>
          </div>
          <div class="kpi-card">
            <div class="kpi-label">Confirmed+ Cost</div>
            <div class="kpi-value">$<%= (kpis.confirmed_cost || 0).toLocaleString() %></div>
          </div>
          <div class="kpi-card">
            <div class="kpi-label">Pipeline Value</div>
            <div class="kpi-value">$<%= (kpis.pipeline_price || 0).toLocaleString() %></div>
          </div>
          <div class="kpi-card">
            <div class="kpi-label">Pipeline Leads</div>
            <div class="kpi-value"><%= kpis.pipeline_count || 0 %></div>
          </div>
        </div>

        <!-- Revenue Graph -->
        <div class="card" style="margin:20px 0;">
          <h2>Revenue Trend (Last 12 Months)</h2>
          <canvas id="revenueChart" style="max-height:300px;"></canvas>
        </div>

        <!-- Upcoming Functions -->
        <div class="card" style="margin-bottom:20px;">
          <h2>Upcoming Functions</h2>
          <table class="pc-table">
            <thead>
              <tr>
                <th>Date</th>
                <th>Time</th>
                <th>Title</th>
                <th>Room</th>
                <th>Guests</th>
                <th>Status</th>
                <th>Value</th>
                <th></th>
              </tr>
            </thead>
            <tbody>
              <% if (!upcoming.length) { %>
                <tr><td colspan="8" class="muted">No upcoming functions</td></tr>
              <% } %>
              <% upcoming.forEach(fn => { %>
                <tr>
                  <td><%= fn.event_date?.toISOString().slice(0,10) %></td>
                  <td><%= fn.event_time || '' %></td>
                  <td><strong><%= fn.event_name %></strong></td>
                  <td><%= fn.room_name || '—' %></td>
                  <td><%= fn.attendees || '—' %></td>
                  <td><span class="status-badge status-<%= fn.status %>"><%= fn.status %></span></td>
                  <td>$<%= (fn.totals_price || 0).toLocaleString() %></td>
                  <td><a href="/api/functions/<%= fn.id %>/edit" class="btn ghost">Edit</a></td>
                </tr>
              <% }) %>
            </tbody>
          </table>
        </div>

        <!-- Recent Leads -->
        <div class="card" style="margin-bottom:20px;">
          <h2>Recent Leads</h2>
          <table class="pc-table">
            <thead>
              <tr>
                <th>Date</th>
                <th>Client</th>
                <th>Contact</th>
                <th>Status</th>
              </tr>
            </thead>
            <tbody>
              <% if (!leads.length) { %>
                <tr><td colspan="4" class="muted">No new leads</td></tr>
              <% } %>
              <% leads.forEach(ld => { %>
                <tr>
                  <td><%= ld.desired_start?.toISOString().slice(0,10) %></td>
                  <td><strong><%= ld.client_name %></strong></td>
                  <td>
                    <%= ld.client_email || '' %>
                    <% if (ld.client_phone) { %><br><span class="muted"><%= ld.client_phone %></span><% } %>
                  </td>
                  <td><span class="pill <%= ld.status %>"><%= ld.status %></span></td>
                </tr>
              <% }) %>
            </tbody>
          </table>
        </div>

        <!-- My Tasks -->
        <div class="card">
          <h2>My Tasks</h2>
          <% if (!tasks.length) { %>
            <div class="muted">No open tasks</div>
          <% } else { %>
            <table class="pc-table">
              <thead>
                <tr>
                  <th>Task</th>
                  <th>Assignee</th>
                  <th>Due</th>
                  <th>Status</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                <% tasks.forEach(t => { %>
                  <tr>
                    <td><%= t.title %></td>
                    <td><%= t.assignee || '—' %></td>
                    <td><%= t.due_at ? t.due_at.toISOString().slice(0,10) : '—' %></td>
                    <td><%= t.status %></td>
                    <td>
                      <a href="/tasks/<%= t.id %>" class="btn-sm">View</a>
                      <a href="/tasks/<%= t.id %>/edit" class="btn-sm">Edit</a>
                      <form method="POST" action="/tasks/<%= t.id %>/toggle" style="display:inline;">
                        <button type="submit" class="btn-sm"><%= t.status === 'complete' ? 'Undo' : 'Complete' %></button>
                      </form>
                    </td>
                  </tr>
                <% }) %>
              </tbody>
            </table>
          <% } %>
        </div>
      </div>
    </main>
  </div>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    const revenueLabels = <%- JSON.stringify(graph.labels || []) %>;
    const revenueData   = <%- JSON.stringify(graph.data   || []) %>;

    const ctx = document.getElementById('revenueChart').getContext('2d');
    new Chart(ctx, {
      type: 'line',
      data: {
        labels: revenueLabels,
        datasets: [{
          label: 'Revenue (Confirmed+)',
          data: revenueData,
          borderColor: '#6bb4de',
          backgroundColor: 'rgba(107, 180, 222, 0.2)',
          tension: 0.3,
          fill: true
        }]
      },
      options: {
        responsive: true,
        plugins: { legend: { display: false } },
        scales: {
          y: { beginAtZero: true, ticks: { callback: v => '$' + v.toLocaleString() } }
        }
      }
    });
  </script>
</body>
</html>





